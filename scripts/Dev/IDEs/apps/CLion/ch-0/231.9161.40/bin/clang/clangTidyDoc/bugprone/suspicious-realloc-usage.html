<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>clang-tidy - bugprone-suspicious-realloc-usage</title>
	/* CLION CLANG-TIDY DOCUMENTATION CSS PLACEHOLDER */
  </head>
  <body><div class="content"><section id="bugprone-suspicious-realloc-usage">
<h1>bugprone-suspicious-realloc-usage</h1>
<p>This check finds usages of <code class="docutils literal notranslate"><span class="pre">realloc</span></code> where the return value is assigned to the
same expression as passed to the first argument:
<code class="docutils literal notranslate"><span class="pre">p</span> <span class="pre">=</span> <span class="pre">realloc(p,</span> <span class="pre">size);</span></code>
The problem with this construct is that if <code class="docutils literal notranslate"><span class="pre">realloc</span></code> fails it returns a
null pointer but does not deallocate the original memory. If no other variable
is pointing to it, the original memory block is not available any more for the
program to use or free. In either case <code class="docutils literal notranslate"><span class="pre">p</span> <span class="pre">=</span> <span class="pre">realloc(p,</span> <span class="pre">size);</span></code> indicates bad
coding style and can be replaced by <code class="docutils literal notranslate"><span class="pre">q</span> <span class="pre">=</span> <span class="pre">realloc(p,</span> <span class="pre">size);</span></code>.</p>
<p>The pointer expression (used at <code class="docutils literal notranslate"><span class="pre">realloc</span></code>) can be a variable or a field member
of a data structure, but can not contain function calls or unresolved types.</p>
<p>In obvious cases when the pointer used at realloc is assigned to another
variable before the <code class="docutils literal notranslate"><span class="pre">realloc</span></code> call, no warning is emitted. This happens only
if a simple expression in form of <code class="docutils literal notranslate"><span class="pre">q</span> <span class="pre">=</span> <span class="pre">p</span></code> or <code class="docutils literal notranslate"><span class="pre">void</span> <span class="pre">*q</span> <span class="pre">=</span> <span class="pre">p</span></code> is found in the
same function where <code class="docutils literal notranslate"><span class="pre">p</span> <span class="pre">=</span> <span class="pre">realloc(p,</span> <span class="pre">...)</span></code> is found. The assignment has to be
before the call to realloc (but otherwise at any place) in the same function.
This suppression works only if <code class="docutils literal notranslate"><span class="pre">p</span></code> is a single variable.</p>
<p>Examples:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">struct</span><span class="w"> </span><span class="nc">A</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">p</span><span class="p">;</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>

<span class="n">A</span><span class="w"> </span><span class="o">&amp;</span><span class="nf">getA</span><span class="p">();</span><span class="w"></span>

<span class="kt">void</span><span class="w"> </span><span class="nf">foo</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">A</span><span class="w"> </span><span class="o">*</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">new_size</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">realloc</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">new_size</span><span class="p">);</span><span class="w"> </span><span class="c1">// warning: &#39;p&#39; may be set to null if &#39;realloc&#39; fails, which may result in a leak of the original buffer</span>
<span class="w">  </span><span class="n">a</span><span class="o">-&gt;</span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">realloc</span><span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">new_size</span><span class="p">);</span><span class="w"> </span><span class="c1">// warning: &#39;a-&gt;p&#39; may be set to null if &#39;realloc&#39; fails, which may result in a leak of the original buffer</span>
<span class="w">  </span><span class="n">getA</span><span class="p">().</span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">realloc</span><span class="p">(</span><span class="n">getA</span><span class="p">().</span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">new_size</span><span class="p">);</span><span class="w"> </span><span class="c1">// no warning</span>
<span class="p">}</span><span class="w"></span>

<span class="kt">void</span><span class="w"> </span><span class="nf">foo1</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">new_size</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">p1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">realloc</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">new_size</span><span class="p">);</span><span class="w"> </span><span class="c1">// no warning</span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
</div></body>
</html>